<!doctype html>  
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" > 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>finde me a drink, now</title>
  <script src="http://code.google.com/apis/gears/gears_init.js" type="text/javascript" charset="utf-8"></script> 
	<script src="js/geo.js?id=1" type="text/javascript" charset="utf-8"></script> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript" ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.js" type="text/javascript" ></script>
    
    <script src='js/humane.js'></script>
    <script src='js/jquery.flip.js'></script>
     <link rel='stylesheet' href='js/humane-themes/bold-dark.css'>
    <script src="http://cdn.socket.io/stable/socket.io.js"></script>
  <!-- The framework --> 
  <link rel="stylesheet" href="css/inuit.css" /> 
  
  <!-- Your extension --> 
  <link rel="stylesheet" href="css/style.css" /> 
  
  <!-- Favicons and the like --> 
  <link rel="shortcut icon" href="/img/knight.png" /> 
  <link rel="apple-touch-icon-precomposed" href="/img/knight.png" /> 
    
    <!-- <script src="/nowjs/now.js"></script> -->
    <script>
    $(function() {
      var lastData=[];
      var wholeData=[];
      var radius = 1;
      var wholeDataLength=(wholeData.length+0);
  
      var success_callback = function(d)
      {
        var latitude = d["coords"]["latitude"];
        var longitude = d["coords"]["longitude"];
        
        var c = new io.Socket("127.0.0.1", {port:3001});
        c.on("connect", function() {
          c.send({
            "func":"stuffAround",
            "latitude":latitude,
            "longitude":longitude,
            "radius":radius,
            "offset":0
          });
          //humane("up and running, baby");
        });
        
        
        
        c.on("message", function(b) {
          //console.log(b);
          //humane("I luv data!");
           b = JSON.parse(b);
          if(!b[0])
          {
            //keine daten
            
            if(radius<5)
            {
              radius = radius + 1;
              console.log('***NO DATA***');
              humane("radius "+radius);
              c.send({
                "func":"stuffAround",
                "latitude":latitude,
                "longitude":longitude,
                "radius":radius,
                "offset":(wholeData.length+1)
              });
            }
            else
            {
              humane("sorry, no drinks for you (in our database)");
            }
            
          }
          else
          {
            console.log('**** D A T A ***');
            console.log(b[0]);
            console.log(typeof b[0]);
            //console.log(b);
            lastData = [];
            //b = JSON.parse(b);
            console.log(b);
            wholeData = wholeData.concat(b);
            //console.log(wholeData);
            b.forEach(function(e){
            
            var advanced_google_maps_url = e.google_maps_url+'&markers=icon:http%3A%2F%2Fwww.facesaerch.com%2Fimages%2Fknight.png|'+latitude+','+longitude;//'&style=feature:road.local%7Celement:geometry%7Chue:0x000000%7Csaturation:0&style=feature:landscape%7Celement:geometry%7Clightness:+100';
            var starA = [];
            for(var i = 1; i<=e.rating; i++)
            {
              starA.push('<img src="/img/star.png">');
            }
            if(starA.length<e.rating)
            {
              starA.push('<img src="/img/half.png">');
            }
            
             // console.log(e);
           
             $(['<div class="aplace" id="place'+e.spot_id+'">',
                '<h3>',
                  '<a href="'+e.external_url+'" target="_blank">',
                  e.name,
                  '</a>',
                '</h3>',
                '<div >',
                  '<div>',
                    e.street,
                  '</div>',
                    '<a href="'+e.external_url+'" target="_blank">',
                      '<img src="'+advanced_google_maps_url+'">',
                    '</a>',
                  '<div>',
                    e.category,
                  '</div>',
                  '<div>',
                    starA.join(''),
                  '</div>',
                '</div>',
              '</div>'
             ].join('')).click(function(elem){
              //console.dir(elem);
             $(this).flip({
	              direction:'lr',
	              color:'#4a8ec2',
	              content:$(['<div class="aplace" id="place_backside_'+e.spot_id+'">',
                '<h3>',
                  '<a href="'+e.external_url+'" target="_blank">',
                  e.name,
                  '</a>',
                '</h3>',
                '<div >',
                  '<div>',
                    e.street,
                  '</div>',
                    '<a href="'+e.external_url+'" target="_blank">',
                      '<img src="'+advanced_google_maps_url+'">',
                    '</a>',
                  '<div>',
                    e.website_url_formatted,
                  '</div>',
                  '<div>',
                    starA.join(''),
                  '</div>',
                '</div>',
              '</div>'
             ].join(''))
              });
             }).appendTo('#places');
          
          });
           
           //more button
           if((wholeDataLength!==wholeData.length)&&wholeData.length<50)
           {
            wholeDataLength=wholeData.length;
            var myid="hudriwudri"+wholeData.length;
            $('#places').append(
            ['<div class="aplace more" id="'+myid+'">',
              '<div>',
                  '<b class="boldium">',
                    'more',
                  '</b>',
                  '</div>',
            '</div>'
             ].join(''));
             
               $("#"+myid).click(function(e){ 
               humane("Ok, looking for more places!");
              c.send({
                "func":"stuffAround",
                "latitude":latitude,
                "longitude":longitude,
                "radius":radius,
                "offset":(wholeData.length+1)
              });
              console.log("offset length");
              console.log(wholeData.length);
              $("#"+myid).remove();
              $('.more').remove();
             
             });
            }
            
          }
          
        });
        
        c.on("disconnect", function() {
          humane("Oh frak, i lost the connection!");
        });
        c.connect();
        
      }
      
      var error_callback = function(e)
      {
        console.log(e);
        humane("No drink's for you! There was an error!");
      }
    
      if(geo_position_js.init()){
       humane("Let's find you somewhere to drink!");
   geo_position_js.getCurrentPosition(success_callback,error_callback);
    }
    else{
    alert("I don't now where you are! Get a <a href='http://www.google.com/chrome/intl/en/make/download-mac.html?brand=CHKZ'>better browser</a>!");
    }
    });
    
    </script>
  </head>
  <body>
    <h1><img src='/img/knight.png'> FindMeADrink</h1>
    <div id='places'>
      
    </div>
  </body>
</html>